<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title></title>
		<style type="text/css">
			* {
				margin: 0;
				padding: 0;
			}
			
			body,
			html {
				width: 100%;
				height: 100%;
			}
			
			#shouquan {
				position: fixed;
				top: 40%;
				left: 25%;
				width: 50%;
				height: 50px;
				line-height: 50px;
				text-align: center;
				background-color: #048E02;
				color: white;
				border-radius: 5px;
				font-family: "微软雅黑";
				font-size: 18px;
			}
		</style>
	</head>

	<body>
		<div id="shouquan">授权</div>

		<script src="js/jquery-2.1.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<script src="js/common.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var username = window.location.href.split("?")[1].split("&")[0].split("=")[1];
			var openid = window.location.href.split("?")[1].split("&")[1].split("=")[1];
			var fxz_code = window.location.href.split("?")[1].split("&")[2].split("=")[1];
			var FXZ_WXJS_READY_FLAG = 0; //微信JS配置完毕标志,0未完成,1完成
			var wxopenid = ""; //粉小猪全局变量,,当前用户openid
			var access_code = "";
			getopenid();
			$("#shouquan").on("click", function() {
				$.ajax({
					type: "get",
					url: "http://testwx.nbguohe.top/index.php/user/user/addAdministrators2",
					data: {
						username: username,
						openid: openid,
						openid2: wxopenid,
						fxz_code: fxz_code
					},
					dataType: "json",
					xhrFields: {
						withCredentials: true
					},
					async: true,
					success: function(data) {
						alert(data.info);
					}
				});
			});

			function getopenid() {
				wxopenid = getcookie('wxopenid');
				access_code = GetQueryString('code');
				if(wxopenid == "") {
					if(access_code == null) {
						var fromurl = location.href;
						var url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxb76b3437a5b415b9&redirect_uri=' + fromurl + '&response_type=code&scope=snsapi_base&state=STATE%23wechat_redirect&connect_redirect=1#wechat_redirect';
						window.location.href = url;
					} else {
						$.ajax({
							type: 'get',
							url: 'http://testwx.nbguohe.top/index.php/user/user/oauth',
							async: false,
							cache: false,
							data: {
								code: access_code
							},
							dataType: 'json',
							success: function(result) {
								if(result != null && result.hasOwnProperty('openid') && result.openid != "") {
									addcookie('wxopenid', result.openid, 360000);
									getlogininfo(result.openid);
									wxopenid = result.openid;
									//config_wxjs();
								} else {
									window.location.href = fromurl;
								}
							}
						});
					}
				} else {
					//config_wxjs();
				}
			}
		</script>
	</body>

</html>